<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo file .ical từ ngày âm lịch</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.5; }
        textarea { width: 100%; padding: 10px; }
        button { padding: 10px 15px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <h2>Tạo file .ical từ ngày âm lịch</h2>

    <label><b>Nhập sự kiện (âm lịch):</b></label><br>
    <textarea id="input" rows="8">#5
10/03: Giỗ tổ Hùng Vương
23/12: Ông Táo Chầu Trời
e/12: Giao thừa</textarea><br><br>

    <button onclick="generateICS()">Tạo file .ical</button>

    <h3>Kết quả (.ical):</h3>
    <pre id="output"></pre>

    <script>
        function parseInput(input) {
            const lines = input.trim().split('\n');
            let numYears = parseInt(lines.shift().substring(1));
            numYears = Math.max(2, Math.min(numYears, 20));

            const events = lines.map(line => {
                const [date, title] = line.split(':');
                const [day, month] = date.trim().split('/');
                return { day: day.trim(), month: parseInt(month), title: title.trim() };
            });

            return { numYears, events };
        }

        function lunarToSolar(year, month, day) {
            const solar = Lunar.fromYmd(year, month, day).getSolar();
            return { year: solar.getYear(), month: solar.getMonth(), day: solar.getDay() };
        }

        function getLastLunarDay(year, month) {
            return Lunar.fromYm(year, month).getDayCount();
        }

        function generateICS() {
            const input = document.getElementById('input').value;
            const { numYears, events } = parseInput(input);
            const now = new Date();
            let ics = "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nCALSCALE:GREGORIAN\r\n";

            for (let i = 0; i < numYears; i++) {
                const year = now.getFullYear() + i;

                events.forEach(event => {
                    const lunarDay = event.day === 'e' ? getLastLunarDay(year, event.month) : parseInt(event.day);
                    const solar = lunarToSolar(year, event.month, lunarDay);
                    const dateString = `${solar.year}${String(solar.month).padStart(2,'0')}${String(solar.day).padStart(2,'0')}`;

                    ics += `BEGIN:VEVENT\r\n`;
                    ics += `SUMMARY:${event.title}\r\n`;
                    ics += `DTSTART;VALUE=DATE:${dateString}\r\n`;
                    ics += `DTEND;VALUE=DATE:${dateString}\r\n`;
                    ics += `END:VEVENT\r\n`;
                });
            }

            ics += "END:VCALENDAR";
            document.getElementById('output').innerText = ics;
        }
    </script>
</body>
</html>
